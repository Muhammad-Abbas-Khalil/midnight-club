<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE MIDNIGHT CLUB</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom Config for Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        black: '#050505',
                        neonGreen: '#0f0',
                        hotPink: '#f0f',
                        offBlack: '#0a0a0a',
                    },
                    fontFamily: {
                        mono: ['"Fira Code"', '"Courier New"', 'monospace'],
                    },
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'glitch': 'glitch 1s linear infinite',
                    },
                    keyframes: {
                        glitch: {
                            '2%, 64%': { transform: 'translate(2px,0) skew(0deg)' },
                            '4%, 60%': { transform: 'translate(-2px,0) skew(0deg)' },
                            '62%': { transform: 'translate(0,0) skew(5deg)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* CORE AESTHETICS */
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap');

        body {
            background-color: #050505;
            color: #0f0;
            font-family: 'Fira Code', 'Courier New', monospace;
            overflow: hidden;
        }

        /* CRT EFFECT OVERLAY */
        .crt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%,
                    rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg,
                    rgba(255, 0, 0, 0.06),
                    rgba(0, 255, 0, 0.02),
                    rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 999;
            animation: crt-flicker 0.15s infinite;
        }

        @keyframes crt-flicker {
            0% {
                opacity: 0.95;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.98;
            }
        }

        /* CUSTOM UTILITIES */
        .text-neon {
            text-shadow: 0 0 5px #0f0, 0 0 10px #0f0, 0 0 20px #0f0;
        }

        .text-pink {
            color: #f0f;
            text-shadow: 0 0 5px #f0f, 0 0 10px #f0f;
        }

        .border-neon {
            box-shadow: 0 0 5px #0f0, inset 0 0 5px #0f0;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #050505;
        }

        ::-webkit-scrollbar-thumb {
            background: #0f0;
            border: 1px solid #050505;
        }

        /* UTILITY CLASSES */
        .hidden {
            display: none !important;
        }

        /* TERMINAL CURSOR */
        .cursor-blink::after {
            content: '_';
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }
    </style>
</head>

<body class="h-screen w-screen flex flex-col items-center justify-center p-4">

    <!-- CRT OVERLAY -->
    <div class="crt-overlay"></div>

    <!-- MAIN TITLE -->
    <header class="absolute top-4 left-4 z-50">
        <h1 class="text-2xl md:text-3xl font-bold tracking-tighter animate-glitch text-neon">
            THE MIDNIGHT CLUB
        </h1>
        <div id="connection-status" class="text-xs text-pink mt-1 opacity-70">
            [SECURE_CONNECTION_ESTABLISHED]
        </div>
    </header>

    <!-- CONTENT: LOCKED STATE -->
    <div id="locked-state" class="hidden flex-col items-center justify-center text-center z-10 w-full max-w-2xl">
        <div class="border border-neon p-8 bg-black bg-opacity-80 w-full">
            <h2 class="text-xl mb-6 tracking-widest text-pink font-bold">ACCESS DENIED</h2>
            <div class="text-6xl md:text-8xl font-bold mb-4 font-mono" id="countdown">00:00:00</div>
            <p class="text-sm md:text-base animate-pulse text-neon mt-4 uppercase tracking-widest">
                We open when the city sleeps.
            </p>
            <div class="mt-8 text-xs text-gray-500 border-t border-gray-800 pt-4">
                HOURS: 23:00 - 03:00 LOCAL TIME
            </div>
        </div>
    </div>

    <!-- CONTENT: OPEN STATE (LOGIN) -->
    <div id="login-state" class="hidden flex-col items-center justify-center z-10 w-full max-w-md">
        <div class="border border-neon p-6 bg-black bg-opacity-90 w-full">
            <h2 class="text-lg mb-4 text-neon">> AUTHENTICATE_USER</h2>
            <div class="mb-6">
                <input type="text" id="alias-input" placeholder="ENTER ALIAS..."
                    class="w-full bg-black border-b-2 border-neon text-neon focus:outline-none focus:border-pink py-2 font-mono uppercase"
                    maxlength="15" autocomplete="off">
            </div>
            <button id="enter-btn"
                class="w-full border border-neon text-neon hover:bg-neonGreen hover:text-black py-3 font-bold transition-all duration-200 uppercase tracking-widest">
                ENTER THE FLOOR
            </button>
        </div>
    </div>

    <!-- CONTENT: OPEN STATE (CHAT FLOOR) -->
    <div id="chat-state" class="hidden flex-col w-full h-full max-w-4xl pt-20 pb-4 z-10 px-2 md:px-0">

        <!-- MAIN CHAT AREA -->
        <div class="flex-1 flex flex-col border border-neon bg-black bg-opacity-80 h-full overflow-hidden w-full">

            <!-- CHAT HEADER -->
            <div class="flex justify-between items-center p-2 border-b border-neon bg-offBlack text-xs md:text-sm">
                <div>
                    <span class="text-neon font-bold animate-pulse">THE_NOODLE_SHOP.net</span>
                </div>
                <div>
                    <span class="text-gray-400">USER:</span> <span id="user-display" class="text-pink">GUEST</span>
                </div>
                <div class="hidden md:block">
                    <span class="text-pink">T-MINUS: <span id="self-destruct-timer"
                            class="font-bold">--:--:--</span></span>
                </div>
            </div>

            <!-- CHAT FEED -->
            <div id="chat-feed"
                class="flex-1 overflow-y-auto p-4 space-y-2 font-mono text-sm md:text-base scroll-smooth">
                <div class="opacity-50 italic text-xs">> SYSTEM: Establishing neural link...</div>
            </div>

            <!-- INPUT AREA -->
            <div class="p-2 bg-black border-t border-gray-800">
                <div class="flex space-x-2">
                    <input type="text" id="message-input"
                        class="flex-1 bg-offBlack border border-gray-700 p-3 text-neon focus:outline-none focus:border-neon font-mono placeholder-gray-700"
                        placeholder="TRANSMIT..." autocomplete="off">
                    <button id="send-btn"
                        class="bg-neonGreen text-black px-4 md:px-6 font-bold hover:bg-white transition-colors uppercase text-sm md:text-base">
                        SEND
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTENT: SYSTEM WIPE ANIMATION -->
    <div id="wipe-state" class="hidden fixed inset-0 bg-black z-[100] flex items-center justify-center flex-col">
        <h1 class="text-4xl md:text-6xl text-pink font-bold animate-pulse text-center">SYSTEM PURGE_INITIATED</h1>
        <div class="w-64 h-2 bg-gray-900 mt-8 rounded overflow-hidden">
            <div class="h-full bg-pink w-0 animate-[width_3s_ease-in-out_forwards]" style="transition: width 3s;"></div>
        </div>
        <p class="mt-4 text-neon font-mono text-xs">ERASING TRACES...</p>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        // ---------------------------------------------------------
        // 1. CONFIGURATION & STATE
        // ---------------------------------------------------------

        const USE_FIREBASE = true;

        const firebaseConfig = {
            apiKey: "[GCP_API_KEY]",
            authDomain: "midnight-club-6b9f4.firebaseapp.com",
            databaseURL: "https://midnight-club-6b9f4-default-rtdb.firebaseio.com",
            projectId: "midnight-club-6b9f4",
            storageBucket: "midnight-club-6b9f4.firebasestorage.app",
            messagingSenderId: "151877926407",
            appId: "1:151877926407:web:a12fc3abbefa46551f74a2",
            measurementId: "G-K3V8SC2JB6"
        };

        const ROOMS = {
            'main': { name: 'MAIN_FLOOR', desc: 'General Frequency' },
            'confession': { name: 'CONFESSION_BOOTH', desc: 'Anonymous Logs' },
            'philosophy': { name: 'PHILOSOPHY_CNR', desc: 'Deep Thoughts' },
            'ghosts': { name: 'GHOST_STORIES', desc: 'Urban Legends' },
            'games': { name: 'ARCADE_ROOM', desc: 'Simulation Deck' }
        };
        // --- GLOBAL VARIABLES ---
        let currentUser = null;
        let db = null;
        let messagesRef = null;
        let push = null;
        let serverTimestamp = null;
        let onChildAdded = null;
        let off = null;

        // Idle Kick Config
        let lastActive = Date.now();
        const IDLE_TIMEOUT = 60 * 1000; // 60 seconds

        // Local State
        let localMessages = [];

        // Elements
        const elLocked = document.getElementById('locked-state');
        const elLogin = document.getElementById('login-state');
        const elChat = document.getElementById('chat-state');
        const elWipe = document.getElementById('wipe-state');
        const elCountdown = document.getElementById('countdown');
        const elSelfDestruct = document.getElementById('self-destruct-timer');
        const elChatFeed = document.getElementById('chat-feed');
        const elMessageInput = document.getElementById('message-input');

        // ---------------------------------------------------------
        // 2. THE BOUNCER (TIME & IDLE LOGIC)
        // ---------------------------------------------------------

        function checkTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();

            // CLUB HOURS: 23:00 (11PM) to 03:00 (3AM)
            // const isClubOpen = (hours >= 23) || (hours < 3);
            const isClubOpen = true; // DEV MODE: ALWAYS OPEN

            // AUTO WIPE CHECK
            if (hours === 3 && minutes === 1 && seconds < 5) {
                triggerWipe();
                return;
            }

            // IDLE CHECK (Global now since single room)
            if (currentUser && !elChat.classList.contains('hidden')) {
                if (Date.now() - lastActive > IDLE_TIMEOUT) {
                    triggerKick();
                    return;
                }
            }

            if (isClubOpen) {
                if (elWipe.classList.contains('hidden')) {
                    if (!currentUser) {
                        showScreen('login');
                    } else {
                        if (elChat.classList.contains('hidden')) {
                            showScreen('chat');
                            initChat();
                        }
                    }
                }

                // UPDATE SELF-DESTRUCT TIMER
                let target = new Date();
                if (hours >= 23) {
                    target.setDate(target.getDate() + 1);
                    target.setHours(3, 0, 0, 0);
                } else {
                    target.setHours(3, 0, 0, 0);
                }
                updateTimerDisplay(elSelfDestruct, target);

            } else {
                showScreen('locked');
                let target = new Date();
                target.setHours(23, 0, 0, 0);
                updateTimerDisplay(elCountdown, target);
            }
        }

        function trackActivity() {
            lastActive = Date.now();
        }

        function updateTimerDisplay(element, targetDate) {
            const now = new Date();
            const diff = targetDate - now;

            if (diff <= 0) {
                element.innerText = "00:00:00";
                return;
            }

            const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);
            element.innerText = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function showScreen(screenName) {
            const screens = { locked: elLocked, login: elLogin, chat: elChat, wipe: elWipe };
            for (const key in screens) {
                if (key === screenName) {
                    screens[key].classList.remove('hidden');
                    screens[key].classList.add('flex');
                } else {
                    screens[key].classList.add('hidden');
                    screens[key].classList.remove('flex');
                }
            }
        }

        function triggerWipe() {
            showScreen('wipe');
            currentUser = null;
            setTimeout(() => { window.location.reload(); }, 4000);
        }

        function triggerKick() {
            showScreen('wipe');
            const h1 = elWipe.querySelector('h1');
            const p = elWipe.querySelector('p');
            if (h1) h1.innerText = "CONNECTION TERMINATED";
            if (p) p.innerText = "IDLE_TIMEOUT [60s]. REBOOTING...";
            currentUser = null;
            setTimeout(() => { window.location.reload(); }, 3000);
        }

        // ---------------------------------------------------------
        // 3. UI RENDERING
        // ---------------------------------------------------------

        // renderRoomList function removed as it's no longer needed.

        // ---------------------------------------------------------
        // 4. APP LOGIC
        // ---------------------------------------------------------

        async function initApp() {
            setInterval(checkTime, 1000);
            checkTime();

            // Activity Tracking
            ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'].forEach(evt => {
                document.addEventListener(evt, trackActivity);
            });

            document.getElementById('enter-btn').addEventListener('click', login);
            document.getElementById('alias-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') login();
            });

            document.getElementById('send-btn').addEventListener('click', sendMessage);
            elMessageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            if (USE_FIREBASE) {
                try {
                    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
                    const firebaseDatabase = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');

                    const { getDatabase, ref, onChildAdded: oca, off: offSubscribe, push: fbPush, serverTimestamp: fbSt } = firebaseDatabase;

                    // Assign to globals
                    push = fbPush;
                    serverTimestamp = fbSt;
                    onChildAdded = oca;
                    off = offSubscribe;

                    const app = initializeApp(firebaseConfig);
                    db = getDatabase(app);

                    console.log("[SYSTEM] Firebase Ready.");
                } catch (e) {
                    console.error("Firebase Init Error:", e);
                    appendMessage("SYSTEM", "CONNECTION ERROR. SWITCHING TO LOCAL SIMULATION.", Date.now());
                }
            }
        }

        function login() {
            const input = document.getElementById('alias-input');
            const alias = input.value.trim().toUpperCase();

            if (alias.length > 0) {
                currentUser = alias;
                document.getElementById('user-display').innerText = currentUser;
                showScreen('chat');

                initChat();
            }
        }

        function initChat() {
            // Check if already initialized to avoid double sub
            if (messagesRef) return;

            elChatFeed.innerHTML = '';
            appendMessage('SYSTEM', `CONNECTED TO MAIN_FLOOR.exe...`, Date.now());

            if (USE_FIREBASE && db) {
                subscribeToFirebase();
            } else {
                // LOCAL MODE - Load history
                localMessages.forEach(m => appendMessage(m.user, m.text, m.timestamp));
            }
        }

        // Subscribe to MAIN room messages (flattened structure or just 'main')
        async function subscribeToFirebase() {
            const firebaseDatabase = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
            const { ref } = firebaseDatabase;

            // WE WILL USE 'main' as the default bucket still to keep compatibility or just 'messages'
            // Let's stick to rooms/main so we don't lose chat history if the user switches back.
            messagesRef = ref(db, `rooms/main/messages`);

            // Initial Load & Listen
            onChildAdded(messagesRef, (snapshot) => {
                const data = snapshot.val();
                appendMessage(data.user, data.text, data.timestamp);
            });
        }

        function sendMessage() {
            const text = elMessageInput.value.trim();
            if (!text || !currentUser) return;



            if (USE_FIREBASE && db && push) {
                if (!messagesRef) return;
                push(messagesRef, {
                    user: currentUser,
                    text: text,
                    timestamp: serverTimestamp()
                }).catch((e) => appendMessage("SYSTEM", "ERR: " + e.message, Date.now()));
            } else {
                // LOCAL MODE
                const msg = { user: currentUser, text: text, timestamp: Date.now() };
                localMessages.push(msg);
                appendMessage(currentUser, text, Date.now());

                // Sim Bot
                if (Math.random() > 0.6) {
                    setTimeout(() => {
                        const botMsg = { user: "GHOST_NET", text: "I see you...", timestamp: Date.now() };
                        localMessages.push(botMsg);
                        appendMessage("GHOST_NET", botMsg.text, Date.now());
                    }, 1500);
                }
            }
            elMessageInput.value = '';
        }



        function appendMessage(user, text, timestamp) {
            const timeStr = new Date(timestamp).toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit' });
            const msgDiv = document.createElement('div');
            msgDiv.className = "mb-1 hover:bg-gray-900 p-1 rounded transition-colors flex items-start";

            const isMe = (user === currentUser);
            const userColor = isMe ? 'text-neon' : 'text-pink';
            // System msgs
            const isSystem = (user === 'SYSTEM');
            const nameDisplay = isSystem ? `<span class="text-gray-500 font-bold">[SYS]</span>` : `<span class="${userColor} font-bold">[${user}]</span>`;

            msgDiv.innerHTML = `
                <span class="text-gray-600 text-[10px] mr-2 mt-1 font-mono">${timeStr}</span>
                <div class="flex-1">
                    ${nameDisplay} <span class="${isMe ? 'text-gray-100' : 'text-gray-300'} break-words">${escapeHtml(text)}</span>
                </div>
            `;

            elChatFeed.appendChild(msgDiv);
            elChatFeed.scrollTop = elChatFeed.scrollHeight;
        }

        function escapeHtml(text) {
            if (!text) return text;
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        initApp();

    </script>
</body>

</html>